<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Sentinel Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        /* COMMERCIAL DARK BLUE THEME */
        :root {
            --bg-dark: #0f172a;       /* Deep Slate Blue */
            --bg-card: #1e293b;       /* Lighter Blue-Grey */
            --accent-blue: #3b82f6;   /* Bright Tech Blue */
            --text-main: #f1f5f9;     /* Off-white */
            --text-muted: #94a3b8;    /* Muted Blue-Grey */
            --danger-glow: 0 0 15px rgba(220, 53, 69, 0.6);
            --safe-glow: 0 0 15px rgba(25, 135, 84, 0.4);
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        /* HEADER */
        .navbar {
            background-color: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .brand-logo {
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent-blue) !important;
        }

        /* CARDS (Glass Effect) */
        .card {
            background-color: var(--bg-card);
            border: 1px solid #334155;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }
        .card-header {
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid #334155;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        /* SENSOR VALUES */
        .sensor-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        .unit {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* ALARM STATUS */
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .status-safe {
            background-color: rgba(25, 135, 84, 0.2);
            color: #4ade80; /* Bright Green */
            border: 1px solid #198754;
            box-shadow: var(--safe-glow);
        }
        .status-danger {
            background-color: rgba(220, 53, 69, 0.2);
            color: #f87171; /* Bright Red */
            border: 1px solid #dc3545;
            box-shadow: var(--danger-glow);
            animation: pulse 1.5s infinite;
        }

        /* CONTROL BUTTONS */
        .btn-silence {
            background-color: #334155;
            color: var(--text-muted);
            border: 1px solid #475569;
        }
        .btn-silence.active-hazard {
            background-color: #dc3545;
            color: white;
            box-shadow: var(--danger-glow);
        }
        .btn-silence:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* TABLE */
        .table-dark-custom {
            --bs-table-bg: transparent;
            --bs-table-color: var(--text-muted);
            border-color: #334155;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand brand-logo" href="#">
                <i class="bi bi-shield-check me-2"></i>LAB SENTINEL
            </a>
            <span id="connectionStatus" class="badge bg-secondary">Waiting for Data...</span>
        </div>
    </nav>

    <div class="container">
        
        <div class="row g-4 mb-4">
            
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 text-center p-3">
                    <div class="card-header border-0 pb-0">Temperature</div>
                    <div class="card-body">
                        <i class="bi bi-thermometer-half text-primary fs-4 mb-2"></i>
                        <div class="sensor-value" id="dispTemp">--</div>
                        <span class="unit">°Celsius</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card h-100 text-center p-3">
                    <div class="card-header border-0 pb-0">Humidity</div>
                    <div class="card-body">
                        <i class="bi bi-moisture text-info fs-4 mb-2"></i>
                        <div class="sensor-value" id="dispHum">--</div>
                        <span class="unit">% RH</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card h-100 text-center p-3">
                    <div class="card-header border-0 pb-0">Air Quality</div>
                    <div class="card-body">
                        <i class="bi bi-wind text-warning fs-4 mb-2"></i>
                        <div class="sensor-value" id="dispGas1">--</div>
                        <span class="unit">PPM (MQ-135)</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card h-100 text-center p-3">
                    <div class="card-header border-0 pb-0">Combustible Gas</div>
                    <div class="card-body">
                        <i class="bi bi-fire text-danger fs-4 mb-2"></i>
                        <div class="sensor-value" id="dispGas2">--</div>
                        <span class="unit">PPM (MQ-2)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-cpu me-2"></i>System Control</span>
                        <span id="lastUpdated" class="text-muted" style="font-size: 0.75rem;">Last Updated: Never</span>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            
                            <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                                <h5 class="mb-1 text-muted">Current Status</h5>
                                <div id="masterStatusBadge" class="status-badge status-safe d-inline-block">
                                    <i class="bi bi-check-circle-fill me-2"></i>ENVIRONMENT NORMAL
                                </div>
                            </div>

                            <div class="col-md-6 text-center text-md-end">
                                <div class="d-flex justify-content-center justify-content-md-end gap-3 align-items-center">
                                    
                                    <div class="text-center">
                                        <div class="text-muted mb-1" style="font-size: 0.8rem;">FAN STATUS</div>
                                        <i id="iconFan" class="bi bi-fan fs-2 text-secondary"></i>
                                    </div>

                                    <button id="btnSilence" class="btn btn-silence px-4 py-2" onclick="silenceAlarm()" disabled>
                                        <i class="bi bi-volume-mute-fill me-2"></i>SILENCE
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history me-2"></i>Live Data Log (Last 5 Entries)
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark-custom align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Temp</th>
                                    <th>Gas Level</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --------------------------------------------------------------
        // 1. FIREBASE CONFIGURATION
        // --------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE", // <--- PASTE KEY HERE
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "YOUR_DATABASE_URL", // <--- PASTE URL HERE
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dataRef = ref(db, 'lab_monitor'); // Path to your data

        // --------------------------------------------------------------
        // 2. DASHBOARD LOGIC
        // --------------------------------------------------------------
        
        // Define Elements
        const elTemp = document.getElementById('dispTemp');
        const elHum = document.getElementById('dispHum');
        const elGas1 = document.getElementById('dispGas1');
        const elGas2 = document.getElementById('dispGas2');
        const elStatusBadge = document.getElementById('masterStatusBadge');
        const elFanIcon = document.getElementById('iconFan');
        const elBtnSilence = document.getElementById('btnSilence');
        const elConnStatus = document.getElementById('connectionStatus');
        const elTableBody = document.getElementById('logTableBody');
        const elLastUpd = document.getElementById('lastUpdated');

        // SILENCE FUNCTION
        window.silenceAlarm = function() {
            update(dataRef, { "manual_silence": true });
            alert("Signal sent: Silencing Alarm...");
        }

        // LISTENER
        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            
            if(data) {
                // A. Update Values
                elTemp.innerText = data.temp || "--";
                elHum.innerText = data.humidity || "--";
                elGas1.innerText = data.mq135_val || "--";
                elGas2.innerText = data.mq2_val || "--";

                // B. Update Status UI
                const isHazard = data.countermeasure_status === true;
                const isSilenced = data.manual_silence === true;

                if (isHazard) {
                    // DANGER MODE
                    elStatusBadge.className = "status-badge status-danger d-inline-block";
                    elStatusBadge.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>HAZARD DETECTED';
                    
                    // Fan Animation
                    elFanIcon.className = "bi bi-fan fs-2 text-danger fa-spin"; // You can add CSS spin here if desired
                    elFanIcon.style.animation = "spin 1s linear infinite";

                    // Enable Silence Button
                    elBtnSilence.disabled = false;
                    elBtnSilence.className = "btn btn-silence active-hazard px-4 py-2";
                } else {
                    // SAFE MODE
                    elStatusBadge.className = "status-badge status-safe d-inline-block";
                    elStatusBadge.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>ENVIRONMENT NORMAL';
                    
                    // Stop Fan
                    elFanIcon.className = "bi bi-fan fs-2 text-secondary";
                    elFanIcon.style.animation = "none";

                    // Disable Silence Button
                    elBtnSilence.disabled = true;
                    elBtnSilence.className = "btn btn-silence px-4 py-2";
                }

                // C. Connection Status
                elConnStatus.className = "badge bg-success";
                elConnStatus.innerText = "Connected";
                
                const now = new Date();
                elLastUpd.innerText = "Last Updated: " + now.toLocaleTimeString();

                // D. Add Row to Table (Simple Visualization)
                const newRow = `
                    <tr>
                        <td>${now.toLocaleTimeString()}</td>
                        <td>${isHazard ? '<span class="text-danger">HAZARD</span>' : '<span class="text-success">OK</span>'}</td>
                        <td>${data.temp}°C</td>
                        <td>${data.mq2_val}</td>
                    </tr>
                `;
                // Add to top, keep only 5 rows
                elTableBody.insertAdjacentHTML('afterbegin', newRow);
                if(elTableBody.rows.length > 5) elTableBody.deleteRow(5);
            }
        });

        // Add CSS Spin Animation via JS for the fan
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes spin { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>

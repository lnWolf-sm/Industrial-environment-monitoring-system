<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lab Command Center</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .dashboard-header {
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* Card Styling */
        .sensor-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            height: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card-title {
            color: #aaaaaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .data-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffffff;
        }

        .unit {
            font-size: 1rem;
            color: #888;
        }

        /* Fan Animation */
        .fan-icon { font-size: 3rem; color: #555; transition: color 0.3s; }
        .spin { animation: spin 0.8s linear infinite; color: #ef4444; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Status Colors */
        .status-safe { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .status-danger { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.5); animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Gas Bars */
        .progress { height: 8px; background-color: #333; margin-top: 10px; }
        .progress-bar { transition: width 0.5s; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="dashboard-header d-flex justify-content-between align-items-center">
        <h3><i class="bi bi-grid-1x2-fill me-2"></i>LAB MONITOR DASHBOARD</h3>
        <span id="connectionBadge" class="badge bg-secondary">Waiting for Data...</span>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="sensor-card">
                <div class="card-title"><i class="bi bi-thermometer-half"></i> Temperature</div>
                <div class="data-value">
                    <span id="display_temp">--</span>
                    <span class="unit">Â°C</span>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="sensor-card">
                <div class="card-title"><i class="bi bi-droplet-fill"></i> Humidity</div>
                <div class="data-value">
                    <span id="display_hum">--</span>
                    <span class="unit">%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="sensor-card">
                <div class="card-title"><i class="bi bi-wind"></i> Air Quality (MQ-135)</div>
                <div class="data-value" id="display_mq135">--</div>
                <div class="progress">
                    <div id="bar_mq135" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2 d-block">Threshold: 2500</small>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="sensor-card">
                <div class="card-title"><i class="bi bi-fire"></i> Smoke Level (MQ-2)</div>
                <div class="data-value" id="display_mq2">--</div>
                <div class="progress">
                    <div id="bar_mq2" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2 d-block">Threshold: 2500</small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="sensor-card d-flex flex-column justify-content-center">
                <div class="card-title">Overall Status</div>
                <div id="alert_text" class="data-value status-safe">NORMAL</div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="sensor-card">
                <div class="card-title">Exhaust Fan (GPIO 26)</div>
                <i id="fan_icon" class="bi bi-fan fan-icon"></i>
                <div class="mt-3" id="fan_text" style="color:#888;">OFF</div>
            </div>
        </div>
    </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  // ----------------------------------------------------
  // TODO: PASTE YOUR FIREBASE CONFIG HERE
  // ----------------------------------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "...",
    appId: "..."
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dataRef = ref(db, 'lab_monitor'); // Matches ESP32 Path

  // Element Selectors
  const elTemp = document.getElementById('display_temp');
  const elHum = document.getElementById('display_hum');
  const elMq135 = document.getElementById('display_mq135');
  const elMq2 = document.getElementById('display_mq2');
  const barMq135 = document.getElementById('bar_mq135');
  const barMq2 = document.getElementById('bar_mq2');
  const elAlertText = document.getElementById('alert_text');
  const elFanIcon = document.getElementById('fan_icon');
  const elFanText = document.getElementById('fan_text');
  const elBadge = document.getElementById('connectionBadge');

  onValue(dataRef, (snapshot) => {
    const data = snapshot.val();
    if(data) {
        // 1. Update Connection Badge
        elBadge.className = "badge bg-success";
        elBadge.innerText = "Connected";

        // 2. Update Climate
        elTemp.innerText = data.temp.toFixed(1);
        elHum.innerText = data.humidity.toFixed(1);

        // 3. Update Gas Levels
        elMq135.innerText = data.air_quality;
        elMq2.innerText = data.smoke_level;

        // Update Progress Bars (Green -> Red logic)
        updateBar(barMq135, data.air_quality);
        updateBar(barMq2, data.smoke_level);

        // 4. Update Fan & Alerts based on Countermeasure Status
        if(data.countermeasure_status === true) {
            // DANGER
            elAlertText.innerText = "HAZARD DETECTED";
            elAlertText.className = "data-value status-danger";
            
            elFanIcon.classList.add('spin'); // Spin animation
            elFanText.innerText = "ACTIVE (PURGING)";
            elFanText.style.color = "#ef4444";
        } else {
            // SAFE
            elAlertText.innerText = "NORMAL";
            elAlertText.className = "data-value status-safe";
            
            elFanIcon.classList.remove('spin'); // Stop animation
            elFanText.innerText = "OFF / STANDBY";
            elFanText.style.color = "#888";
        }
    }
  });

  // Helper function to color the bars
  function updateBar(element, value) {
      let percent = (value / 4095) * 100;
      element.style.width = percent + "%";
      
      element.classList.remove('bg-success', 'bg-warning', 'bg-danger');
      
      if(value < 1500) element.classList.add('bg-success');
      else if(value < 2500) element.classList.add('bg-warning');
      else element.classList.add('bg-danger');
  }
</script>

</body>
</html>